// ===============================================
// SCRIPT DO FORMUL√ÅRIO DE PAGAMENTO
// ===============================================

// Event listener para bot√£o voltar
document.getElementById('btn-voltar').addEventListener('click', () => {
  window.location.href = 'entrega.html';
});

let selectedPayment = JSON.parse(localStorage.getItem('payment')) || null;

// Selecionar forma de pagamento
document.querySelectorAll('.pay-card').forEach(card => {
  card.addEventListener('click', () => {
    const method = card.dataset.method;
    console.log('üí≥ M√©todo selecionado:', method);
    selectedPayment = { method };
    localStorage.setItem('payment', JSON.stringify(selectedPayment));
    renderPaymentDetails(method);
    document.querySelectorAll('.pay-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
  });
});

function renderPaymentDetails(method) {
  const detailsDiv = document.getElementById('payment-details');
  console.log('üìù Elemento payment-details:', detailsDiv);
  
  if (!detailsDiv) {
    console.error('‚ùå Elemento payment-details n√£o encontrado!');
    return;
  }
  
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const total = cart.reduce((sum, item) => sum + (item.customizedPrice || item.price), 0);
  
  console.log('üí∞ Total:', total);
  console.log('üéØ Renderizando detalhes para:', method);
  
  detailsDiv.classList.add('show');
  
  if (method === 'dinheiro') {
    detailsDiv.innerHTML = `
      <label>Troco para quanto? (opcional)
        <input type="text" id="troco" inputmode="decimal" placeholder="R$ 50,00" maxlength="10">
        <span id="troco-error" style="color: #dc3545; font-size: 0.875rem; margin-top: 4px; display: none;"></span>
      </label>
    `;
    
    // Adicionar valida√ß√£o e formata√ß√£o ao campo troco
    setTimeout(() => {
      const trocoInput = document.getElementById('troco');
      const trocoError = document.getElementById('troco-error');
      
      if (!trocoInput) return;
      
      // Fun√ß√£o para formatar como moeda
      function formatMoney(value) {
        // Remove tudo exceto n√∫meros
        value = value.replace(/\D/g, '');
        
        // Converte para n√∫mero e divide por 100
        value = (parseInt(value) / 100).toFixed(2);
        
        // Formata para padr√£o brasileiro
        value = value.replace('.', ',');
        
        return 'R$ ' + value;
      }
      
      trocoInput.addEventListener('input', (e) => {
        let value = e.target.value;
        
        // Remove o R$ se existir
        value = value.replace('R$', '').trim();
        
        // Se est√° vazio, limpa
        if (value === '') {
          e.target.value = '';
          trocoError.style.display = 'none';
          e.target.style.borderColor = '';
          return;
        }
        
        // Formata como dinheiro
        const formatted = formatMoney(value);
        e.target.value = formatted;
        
        // Validar valor num√©rico
        const numericValue = parseFloat(value.replace(/\D/g, '')) / 100;
        
        // Validar limite de R$ 200,00
        if (numericValue > 200) {
          trocoError.textContent = '‚ö†Ô∏è Troco m√°ximo: R$ 200,00';
          trocoError.style.display = 'block';
          e.target.style.borderColor = '#dc3545';
        } else if (numericValue < 0.01 && value !== '') {
          trocoError.textContent = '‚ö†Ô∏è Valor m√≠nimo: R$ 0,01';
          trocoError.style.display = 'block';
          e.target.style.borderColor = '#dc3545';
        } else {
          trocoError.style.display = 'none';
          e.target.style.borderColor = '';
        }
      });
      
      // Garantir formata√ß√£o ao sair do campo
      trocoInput.addEventListener('blur', (e) => {
        if (e.target.value && !e.target.value.startsWith('R$')) {
          let value = e.target.value.replace(/\D/g, '');
          if (value) {
            e.target.value = formatMoney(value);
          }
        }
      });
    }, 0);
  } else if (method === 'pix') {
    detailsDiv.innerHTML = `
      <p class="payment-total-info">
        ‚úÖ Enviaremos a chave PIX ap√≥s a confirma√ß√£o do pedido.
      </p>
    `;
  } else {
    detailsDiv.innerHTML = `
      <p class="payment-total-info">
        ‚úÖ A maquininha estar√° dispon√≠vel na entrega.
      </p>
    `;
  }
}

// Restaurar sele√ß√£o anterior
if (selectedPayment && selectedPayment.method) {
  const card = document.querySelector(`.pay-card[data-method="${selectedPayment.method}"]`);
  if (card) {
    card.classList.add('active');
    renderPaymentDetails(selectedPayment.method);
  }
}

// Finalizar pedido
document.getElementById('finish-order').addEventListener('click', () => {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart.length === 0) {
    al// Extrair valor num√©rico (remover R$ e converter v√≠rgula)
      const cleanValue = troco.replace('R$', '').replace(/\s/g, '').replace(',', '.');
      const numericValue = parseFloat(cleanValue);
      
      // Validar troco
      if (isNaN(numericValue) || numericValue <= 0) {
        alert('‚ö†Ô∏è Troco inv√°lido! Digite um valor v√°lido
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || !user.endereco) {
    alert('Preencha os dados de entrega.');
    window.location.href = 'entrega.html';
    return;
  }

  if (!selectedPayment || !selectedPayment.method) {
    alert('Escolha a forma de pagamento.');
    return;
  }

  const total = cart.reduce((sum, item) => sum + (item.customizedPrice || item.price), 0);

  if (selectedPayment.method === 'dinheiro') {
    const trocoInput = document.getElementById('troco');
    const troco = trocoInput?.value;
    
    if (troco) {
      const numericValue = parseFloat(troco.replace(',', '.'));
      
      // Validar troco
      if (isNaN(numericValue)) {
        alert('‚ö†Ô∏è Troco inv√°lido! Digite apenas n√∫meros.');
        return;
      }
      
      if (numericValue > 200) {
        alert('‚ö†Ô∏è Troco m√°ximo permitido: R$ 200,00');
        return;
      }
      
      if (numericValue <= total) {
        alert(`‚ö†Ô∏è O valor do troco (R$ ${numericValue.toFixed(2).replace('.', ',')}) deve ser maior que o total do pedido (R$ ${total.toFixed(2).replace('.', ',')})!`);
        return;
      }
      
      selectedPayment.troco = numericValue.toFixed(2);
    }
  }

  localStorage.setItem('payment', JSON.stringify(selectedPayment));
  sendWhatsApp(user, selectedPayment, cart, total);
});
