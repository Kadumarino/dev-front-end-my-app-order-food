<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7cb342">
  <link rel="manifest" href="manifest.json">
  <title>ğŸ” Kadu Lanches - Pagamento</title>
  <link rel="stylesheet" href="estilizacao-lanche.css">
</head>
<body>
  <header class="flow-header">
    <button class="close-flow" onclick="window.location.href='entrega.html'">â†</button>
    <h2>ğŸ’³ Forma de Pagamento</h2>
    <button id="theme-toggle" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">ğŸŒ™</button>
  </header>

  <section class="flow-content" style="padding-top: 20px;">
    <div class="payment-info">
      <h3 style="text-align: center; margin-bottom: 20px; color: var(--text-color);">ğŸ’³ Pagamento na Entrega</h3>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">Selecione a forma de pagamento:</p>
    </div>
    
    <div class="payment-options">
      <div class="pay-card" data-method="credito">
        <div class="pay-title">ğŸ’³ CrÃ©dito</div>
        <p>Pagar com cartÃ£o de crÃ©dito na entrega.</p>
      </div>
      <div class="pay-card" data-method="debito">
        <div class="pay-title">ğŸ’³ DÃ©bito</div>
        <p>Pagar com cartÃ£o de dÃ©bito na entrega.</p>
      </div>
      <div class="pay-card" data-method="dinheiro">
        <div class="pay-title">ğŸ’µ Dinheiro</div>
        <p>Pagar em dinheiro na entrega.</p>
      </div>
    </div>
    
    <div id="payment-details" class="payment-details" style="display: none;"></div>
    
    <div class="flow-actions">
      <button id="finish-order">Finalizar e enviar WhatsApp</button>
    </div>
  </section>

  <script>
    let selectedPayment = JSON.parse(localStorage.getItem('payment')) || null;

    // Selecionar forma de pagamento
    document.querySelectorAll('.pay-card').forEach(card => {
      card.addEventListener('click', () => {
        const method = card.dataset.method;
        selectedPayment = { method };
        localStorage.setItem('payment', JSON.stringify(selectedPayment));
        renderPaymentDetails(method);
        document.querySelectorAll('.pay-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
      });
    });

    function renderPaymentDetails(method) {
      const detailsDiv = document.getElementById('payment-details');
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const total = cart.reduce((sum, item) => sum + (item.customizedPrice || item.price), 0);
      
      detailsDiv.style.display = 'block';
      
      if (method === 'dinheiro') {
        detailsDiv.innerHTML = `
          <label>Troco para quanto? (opcional)
            <input type="number" id="troco" min="0" step="0.01" placeholder="Ex: 50,00">
          </label>
        `;
      } else {
        detailsDiv.innerHTML = `
          <p style="text-align: center; color: var(--text-color); padding: 20px; background: var(--item-bg); border-radius: 8px; margin-top: 20px;">
            âœ… A maquininha estarÃ¡ disponÃ­vel na entrega.
          </p>
        `;
      }
    }

    // Restaurar seleÃ§Ã£o anterior
    if (selectedPayment && selectedPayment.method) {
      const card = document.querySelector(`.pay-card[data-method="${selectedPayment.method}"]`);
      if (card) {
        card.classList.add('active');
        renderPaymentDetails(selectedPayment.method);
      }
    }

    // Finalizar pedido
    document.getElementById('finish-order').addEventListener('click', () => {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cart.length === 0) {
        alert('ğŸ›’ Adicione itens ao carrinho primeiro!');
        window.location.href = 'visual-lanche.html';
        return;
      }

      const user = JSON.parse(localStorage.getItem('user'));
      if (!user || !user.endereco) {
        alert('Preencha os dados de entrega.');
        window.location.href = 'entrega.html';
        return;
      }

      if (!selectedPayment || !selectedPayment.method) {
        alert('Escolha a forma de pagamento.');
        return;
      }

      if (selectedPayment.method === 'dinheiro') {
        const troco = document.getElementById('troco')?.value;
        if (troco) selectedPayment.troco = troco;
      }

      localStorage.setItem('payment', JSON.stringify(selectedPayment));
      const total = cart.reduce((sum, item) => sum + (item.customizedPrice || item.price), 0);
      sendWhatsApp(user, selectedPayment, cart, total);
    });
  </script>
  <script src="js/shared.js"></script>
</body>
</html>
